From d7e3ae48f345bb78899ed51af7762a4a7e53e305 Mon Sep 17 00:00:00 2001
From: Alan Pevec <apevec@redhat.com>
Date: Tue, 11 Feb 2014 22:36:00 +0100
Subject: [PATCH 2/2] notify calling process we are ready to serve

Systemd notification should be sent in-process, otherwise systemd might
miss the subprocess sending notification.
See systemd bug https://bugzilla.redhat.com/show_bug.cgi?id=820448

Taken from keystone project commit
abc06716d027d68f0da3b0f559fa7c85a21804d5

Improvements from Keystone version:

    * add unset_environment parameter
    New parameter unset_environment was added to sd_notify
    http://www.freedesktop.org/software/systemd/man/sd_notify.html
    to ensure service readiness is sent only once.

    * add onready() method to simulate systemd environment
    For testing purposes and optional use with SysV initscripts.

    * unit test added

    * docstrings for notification methods

Patch includes deployment in openstack.common.service.
It does not have an effect when running the service outside
the systemd environment.

Implements: blueprint service-readiness
Change-Id: I80f325c9be9c171c2dc8d5526570bf64f0f87c78
---
 glance/cmd/api.py      | 2 ++
 glance/cmd/registry.py | 2 ++
 2 files changed, 4 insertions(+)

diff --git a/glance/cmd/api.py b/glance/cmd/api.py
index 7594f6a..f0a5aa6 100755
--- a/glance/cmd/api.py
+++ b/glance/cmd/api.py
@@ -50,6 +50,7 @@ from glance.common import exception
 from glance.common import wsgi
 from glance import notifier
 from glance.openstack.common import log
+from glance.openstack.common import systemd
 
 CONF = cfg.CONF
 CONF.import_group("profiler", "glance.common.wsgi")
@@ -88,6 +89,7 @@ def main():
 
         server = wsgi.Server()
         server.start(config.load_paste_app('glance-api'), default_port=9292)
+        systemd.notify_once()
         server.wait()
     except KNOWN_EXCEPTIONS as e:
         fail(e)
diff --git a/glance/cmd/registry.py b/glance/cmd/registry.py
index a3a6a98..360427a 100755
--- a/glance/cmd/registry.py
+++ b/glance/cmd/registry.py
@@ -46,6 +46,7 @@ from glance.common import utils
 from glance.common import wsgi
 from glance import notifier
 from glance.openstack.common import log
+from glance.openstack.common import systemd
 
 CONF = cfg.CONF
 CONF.import_group("profiler", "glance.common.wsgi")
@@ -71,6 +72,7 @@ def main():
         server = wsgi.Server()
         server.start(config.load_paste_app('glance-registry'),
                      default_port=9191)
+        systemd.notify_once()
         server.wait()
     except RuntimeError as e:
         sys.exit("ERROR: %s" % utils.exception_to_str(e))
-- 
1.9.3

